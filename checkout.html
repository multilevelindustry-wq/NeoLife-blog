<!DOCTYPE html>
<html>
<head>
  <title>Checkout</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<header>
  <h2>Checkout</h2>
  <nav>
    <a href="cart.html">Back to Cart</a>
  </nav>
</header>

<div style="padding:40px; text-align:center;">
  <h2>Total Amount: $<span id="totalAmount"></span></h2>

  <!-- PayPal Button Container -->
  <div id="paypal-button-container" style="margin-top:30px;"></div>
  
  <div style="margin-top:20px;">
  <button onclick="payWithPaystack()" 
          style="padding:12px 25px; background:#0ba4db; color:white; border:none; border-radius:5px; cursor:pointer;">
    Pay With Paystack
  </button>
  </div>
</div>

<!-- YOUR PAYPAL SDK (UNCHANGED) -->
<script src="https://www.paypal.com/sdk/js?client-id=Aey_vJzSIErk6JUHmkIU41JQ4W1vA2FlfBNf5Vtkg7j4YLaWHkFtw4WSPI0SWiCzhaNKqPt2oGuVIF1n&components=buttons&currency=USD"></script>
<script src="https://js.paystack.co/v1/inline.js"></script>


  
<script>

if(!localStorage.getItem("loggedIn")){
  alert("Please login first");
  window.location.href = "login.html";
}

// ===============================
// GET CART & TOTAL
// ===============================
let cart = JSON.parse(localStorage.getItem("cart")) || [];

if(cart.length === 0){
  alert("Your cart is empty.");
  window.location.href = "cart.html";
}

let total = 0;
cart.forEach(item => {
  total += item.price * (item.quantity || 1);
});

document.getElementById("totalAmount").innerText = total.toFixed(2);

// ===============================
// PAYPAL BUTTON
// ===============================
paypal.Buttons({

  createOrder: function(data, actions) {
    return actions.order.create({
      purchase_units: [{
        amount: {
          value: total.toFixed(2)
        }
      }]
    });
  },

  onApprove: function(data, actions) {
    return actions.order.capture().then(function(details) {

      let allOrders = JSON.parse(localStorage.getItem("orders")) || [];
      let currentUser = JSON.parse(localStorage.getItem("currentUser"));

      let orderID = "ORD-" + Date.now();

      let order = {
        id: orderID,
        userID: currentUser.id,
        userName: currentUser.name,
        userEmail: currentUser.email,
        items: cart,
        total: total,
        date: new Date().toLocaleString(),
        submitted: false
      };

      allOrders.push(order);
      localStorage.setItem("orders", JSON.stringify(allOrders));

      // Save personal order history
      let userOrders = JSON.parse(localStorage.getItem("userOrders_" + currentUser.email)) || [];
      userOrders.push(order);
      localStorage.setItem("userOrders_" + currentUser.email, JSON.stringify(userOrders));

      // Process PV & Commission
      processPV(currentUser.id, total);

      localStorage.removeItem("cart");

      alert("Payment Successful! Order ID: " + orderID);

      window.location.href = "dashboard.html";

    });
  }

}).render('#paypal-button-container');


// ===============================
// MLM PV PROCESSING
// ===============================
function calculatePV(amount){
  return Math.floor(amount / 10) * 5;
}

function getCommissionRate(user){

  if(user.personalPV >= 2000) return 0.25;
  if(user.personalPV >= 600) return 0.20;
  if(user.personalPV >= 300) return 0.15;

  return 0.10;
}

function processPV(userID, orderAmount){

  let users = JSON.parse(localStorage.getItem("users")) || [];

  let buyer = users.find(u => u.id === userID);
  if(!buyer) return;

  let pv = calculatePV(orderAmount);

  buyer.personalPV += pv;

  // Update Rank
  if(buyer.personalPV >= 2000) buyer.level = "Elite";
  else if(buyer.personalPV >= 600) buyer.level = "Gold";
  else if(buyer.personalPV >= 300) buyer.level = "Silver";
  else buyer.level = "Starter";

  // Sponsor Commission
  if(buyer.sponsorID){

    let sponsor = users.find(u => u.id === buyer.sponsorID);

    if(sponsor){

      let rate = getCommissionRate(sponsor);
      let commission = pv * rate;

      sponsor.teamPV += pv;
      sponsor.totalEarnings += commission;
      sponsor.withdrawable += commission;
    }
  }

  localStorage.setItem("users", JSON.stringify(users));
}



  // ===============================
// PAYSTACK PAYMENT
// ===============================
function payWithPaystack(){

  let currentUser = JSON.parse(localStorage.getItem("currentUser"));
  if(!currentUser){
    alert("Please login first");
    window.location.href = "login.html";
    return;
  }

  let handler = PaystackPop.setup({
    key: 'pk_live_ae2ef39d24e2f001cbc716def10d3ede5148af5b', // PUBLIC KEY ONLY
    email: currentUser.email,
    amount: total * 100, // Paystack uses kobo (multiply by 100)
    currency: "USD", // Change to NGN if needed

    callback: function(response){

      // ===============================
      // SAVE ORDER (SAME AS PAYPAL)
      // ===============================

      let allOrders = JSON.parse(localStorage.getItem("orders")) || [];

      let orderID = "ORD-" + Date.now();

      let order = {
        id: orderID,
        paystackRef: response.reference,
        userID: currentUser.id,
        userName: currentUser.name,
        userEmail: currentUser.email,
        items: cart,
        total: total,
        date: new Date().toLocaleString(),
        submitted: false
      };

      allOrders.push(order);
      localStorage.setItem("orders", JSON.stringify(allOrders));

      // Save personal order history
      let userOrders = JSON.parse(localStorage.getItem("userOrders_" + currentUser.email)) || [];
      userOrders.push(order);
      localStorage.setItem("userOrders_" + currentUser.email, JSON.stringify(userOrders));

      // Process PV & Commission
      processPV(currentUser.id, total);

      localStorage.removeItem("cart");

      alert("Payment Successful! Order ID: " + orderID);

      window.location.href = "dashboard.html";
    },

    onClose: function(){
      alert("Payment cancelled.");
    }

  });

  handler.openIframe();
        }
  
</script>

</body>
</html>

